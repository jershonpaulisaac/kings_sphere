<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f5f7fa;
        color: #2d2d2d;
        line-height: 1.6;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        min-height: 100vh;
        box-sizing: border-box;
      }
      h1 {
        margin-top: 20px;
        margin-bottom: 20px;
        color: #1e3a8a;
        font-weight: 600;
      }
      #reader {
        width: 400px;
        max-width: 100%;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      #scanned-items-container {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #e9e9e9;
        width: 380px;
        max-width: 100%;
        max-height: 300px;
        overflow-y: auto;
        text-align: left;
        font-size: 1.1em;
        color: #333;
        box-sizing: border-box;
      }
      #scanned-items-container p {
        color: #666;
        font-style: italic;
      }
      .scanned-item {
        padding: 8px;
        margin-bottom: 5px;
        border-bottom: 1px dashed #bbb;
        word-wrap: break-word;
        background-color: #fcfcfc;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .scanned-item:last-child {
        border-bottom: none;
      }
      .scanned-item .scanned-id {
        flex-grow: 1;
        margin-right: 10px;
      }
      .scanned-item .attendance-status {
        font-weight: bold;
        color: #28a745;
        white-space: nowrap;
        text-align: right;
      }
      @media (max-width: 500px) {
        #reader {
          width: 100%;
        }
        #scanned-items-container {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>QR Code Scanner</h1>
    <div id="reader"></div>
    <div id="scanned-items-container">
      <p>Scanned IDs will appear here:</p>
    </div>

    <audio id="beepSound" src="beep.mp3" preload="auto"></audio>

    <script>
      const scannedTexts = new Set();
      let lastScannedTime = 0;
      const scanCooldown = 1500;
      const beepSound = document.getElementById("beepSound");

      const GOOGLE_SHEETS_WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbyM_tYyFoIwfl_-XQu9zu1pMsuSparhSaLUjYjd5VeR5UCER_h2wI0rnjLa-vQR12c/exec";

      async function sendScanToGoogleSheet(data) {
        try {
          await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ scannedText: data }),
          });
        } catch (error) {
          alert(
            "Could not send scan to Google Sheet. Please check your internet connection."
          );
        }
      }

      function onScanSuccess(decodedText) {
        const currentTime = new Date().getTime();

        if (
          scannedTexts.has(decodedText) &&
          currentTime - lastScannedTime < scanCooldown
        ) {
          return;
        }

        scannedTexts.add(decodedText);
        lastScannedTime = currentTime;

        const container = document.getElementById("scanned-items-container");
        const placeholder = container.querySelector("p");
        if (
          placeholder &&
          placeholder.textContent === "Scanned IDs will appear here:"
        ) {
          container.innerHTML = "";
        }

        let displayContent = decodedText;
        try {
          const url = new URL(decodedText);
          const nameParam = url.searchParams.get("name");
          if (nameParam) {
            displayContent = decodeURIComponent(nameParam);
          }
        } catch (e) {}

        const newItem = document.createElement("div");
        newItem.classList.add("scanned-item");
        newItem.innerHTML = `
                <span class="scanned-id">${displayContent}</span>
                <span class="attendance-status">- Present</span>
            `;

        container.prepend(newItem);

        if (beepSound) {
          beepSound.currentTime = 0;
          beepSound.play().catch(() => {});
        }

        sendScanToGoogleSheet(decodedText);
      }

      function onScanError() {}

      const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        disableFlip: false,
      });

      html5QrcodeScanner.render(onScanSuccess, onScanError).catch(() => {
        alert(
          "Could not start camera for QR scanning. Please ensure camera access is allowed for this site and try again."
        );
      });
    </script>
  </body>
</html>
